name: CI/CD & Auto-Release

on:
  push:
    branches: [main, master, develop]
    tags:
      - 'v*'
  pull_request:
    branches: [main, master, develop]

env:
  NODE_VERSION: '22'

jobs:
  # ============================================================
  # Stage 1: Validation & Code Quality
  # ============================================================
  quality:
    name: ğŸ”¬ Quality & Lint
    runs-on: ubuntu-latest
    timeout-minutes: 10
    permissions:
      contents: read
    steps:
      - name: ğŸ” Checkout code
        uses: actions/checkout@v4

      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ğŸ“¦ Install dependencies
        run: npm ci

      - name: âœ¨ Prettier Format Check
        run: npm run format:check

      - name: ğŸ§¹ Lint Check
        run: npm run lint

      - name: ğŸ›¡ï¸ TypeScript Type Check
        run: npm run type-check

  # ============================================================
  # Stage 2: Unit Testing
  # ============================================================
  test:
    name: ğŸ§ª Unit Tests
    needs: quality
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: ğŸ” Checkout code
        uses: actions/checkout@v4

      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ğŸ“¦ Install dependencies
        run: npm ci

      - name: ğŸƒ Run Tests
        run: npm test

  # ============================================================
  # Stage 3: Build Standalone EXE
  # ============================================================
  build:
    name: ğŸ—ï¸ Build Standalone EXE
    needs: test
    runs-on: windows-latest
    timeout-minutes: 15
    steps:
      - name: ğŸ” Checkout code
        uses: actions/checkout@v4

      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ğŸ“¦ Install dependencies
        run: npm ci

      - name: ğŸ”¨ Build Standalone EXE
        run: npm run build:sea

      - name: â¬†ï¸ Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: remote-opencode-windows
          path: dist/remote-opencode.exe
          retention-days: 7

  # ============================================================
  # Stage 4: Release & Feedback
  # ============================================================
  release-and-feedback:
    name: ğŸš€ Release & PR Summary
    needs: build
    runs-on: ubuntu-latest
    if: always()
    permissions:
      contents: write
      pull-requests: write
      issues: write

    steps:
      - name: ğŸ” Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ“¥ Download Artifact
        if: needs.build.result == 'success'
        uses: actions/download-artifact@v4
        with:
          name: remote-opencode-windows
          path: .

      - name: ğŸš€ Create GitHub Release
        if: startsWith(github.ref, 'refs/tags/v') && needs.build.result == 'success'
        uses: softprops/action-gh-release@v2
        with:
          files: remote-opencode.exe
          name: Release ${{ github.ref_name }}
          draft: false
          prerelease: false
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ“Š Post PR Summary
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const qualityStatus = "${{ needs.quality.result }}";
            const testStatus = "${{ needs.test.result }}";
            const buildStatus = "${{ needs.build.result }}";

            const check = (status) => status === 'success' ? 'âœ… Passed' : (status === 'skipped' ? 'â­ï¸ Skipped' : 'âŒ Failed');

            const body = `## CI/CD Pipeline Summary

            | Stage | Status |
            |-------|--------|
            | ğŸ”¬ Code Quality | ${check(qualityStatus)} |
            | ğŸ§ª Unit Tests | ${check(testStatus)} |
            | ğŸ—ï¸ Build EXE | ${check(buildStatus)} |

            ${buildStatus === 'success' ? 'Ready for merge and release! ğŸ‰' : 'Please resolve the issues above.'}`;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });
